library(shiny)
library(readr)
library(tidyverse)
library(lubridate)

# Boys
Chronological_Age_Boys <- c(2, 2.03, 2.13, 2.14, 2.25, 2.29, 2.47, 2.49, 2.61, 2.63, 2.74, 2.75, 2.77, 3.09, 
                         3.16, 3.18, 3.19, 3.21, 3.22, 3.25, 3.29, 3.39, 3.39, 3.43, 3.47, 3.73, 3.75, 3.88,
                         3.91, 3.93, 4.02, 4.08, 4.1, 4.18, 4.28, 4.29, 4.35, 4.42, 4.44, 4.46, 4.55, 4.57, 
                         4.64, 4.64, 4.7, 4.77, 4.78, 4.93, 4.99, 5.04, 5.06, 5.07, 5.11, 5.11, 5.12, 5.17, 
                         5.4, 5.45, 5.54, 5.61, 5.72, 5.78, 5.83, 5.93, 6.05, 6.11, 6.15, 6.19, 6.23, 6.46, 
                         6.48, 6.54, 6.8, 6.81, 6.9, 6.91, 6.93, 6.96, 6.99, 7.08, 7.15, 7.26, 7.36, 7.36, 7.46, 
                         7.56, 7.64, 7.68, 7.68, 7.68, 7.69, 7.7, 7.72, 7.74, 7.78, 7.94, 7.97, 7.98, 8.02, 8.14,
                         8.32, 8.45, 8.47, 8.48, 8.56, 8.67, 8.67, 8.81, 8.83, 8.87, 8.93, 8.97, 9.1, 9.18, 9.2, 
                         9.22, 9.41, 9.43, 9.48, 9.58, 9.59, 9.71, 9.85, 9.88, 10.03, 10.07, 10.13, 10.14, 10.15, 
                         10.17, 10.21, 10.22, 10.43, 10.44, 10.53, 10.56, 10.88, 10.89, 11, 11, 11.01, 11.04, 11.17, 
                         11.3, 11.32, 11.32, 11.38, 11.49, 11.63, 11.67, 11.81, 11.84, 11.91, 11.98, 12.1, 12.11, 12.12, 
                         12.13, 12.15, 12.19, 12.21, 12.36, 12.46, 12.5, 12.58, 12.73, 12.77, 12.77, 12.79, 12.93, 13, 13, 
                         13.08, 13.25, 13.25, 13.28, 13.3, 13.31, 13.41, 13.59, 13.6, 13.65, 13.83, 13.89, 13.9, 14.01, 
                         14.05, 14.08, 14.09, 14.14, 14.18, 14.21, 14.36, 14.45, 14.63, 14.71, 14.74, 14.79, 14.87, 14.99, 
                         14.99, 15.07, 15.08, 15.11, 15.24, 15.25, 15.3, 15.31, 15.34, 15.47, 15.53, 15.66, 15.73, 15.76, 
                         15.82, 15.83, 15.86, 15.92, 15.94)

Estimated_Bone_Age_Boys <- c(1.5, 1.5, 2.67, 2.67, 2.67, 1.5, 1.5, 1.75, 3, 2.67, 2.67, 2.67, 2, 2.64, 3.24, 3.72, 2.8, 2.64, 3, 3, 2.48, 
                   5, 3.8, 4, 2.8, 3.48, 3.72, 3.8, 3.48, 2.48, 4.48, 4, 3, 4.24, 3.24, 3, 5, 3.48, 3, 4.24, 5.48, 5.48, 3.48, 
                   4.48, 5.72, 4.48, 3.8, 3.48, 3.48, 5.5, 5.48, 6, 5, 6, 3.48, 3.24, 5, 4.48, 5, 4.48, 5.48, 6, 5.48, 6.48, 5.48, 
                   5.5, 10, 5.5, 6, 6, 6, 7, 7.48, 7, 10.48, 6, 5, 7.5, 6.48, 5.48, 8, 8, 6.48, 6.48, 7.5, 5.5, 7, 9.5, 9, 8, 8.5, 
                   7, 9, 8, 7.48, 8, 5.48, 7, 8, 9.5, 7, 9, 9.48, 8, 9, 8, 8.48, 9, 7.5, 9, 9.48, 10, 8.48, 9, 11, 9, 9.48, 10, 8.48, 
                   9, 12, 9, 8, 9, 10.48, 11, 10, 10, 10.5, 11, 11.48, 10.48, 11, 10.48, 12, 10.48, 11, 10.48, 13, 13, 12, 11.48, 
                   12, 12, 10.48, 11.48, 12.48, 12.48, 11, 13.48, 12.48, 11, 12.48, 13.48, 13.24, 13, 11.48, 12.48, 12.48, 12, 
                   11.48, 12, 12, 12, 11.24, 13.72, 16, 12.72, 13.48, 10, 13, 13.48, 12.48, 12.72, 13.48, 12.48, 13.48, 13, 12.48, 
                   13, 13.48, 12.48, 12.48, 14, 14, 14, 13.72, 15, 15.24, 15, 14, 15, 14.48, 14, 15, 17, 16, 14, 13.48, 13.48, 
                   14, 15.72, 14, 17, 13.72, 16, 13.72, 17, 13.48, 14, 18, 14.48, 17, 16, 18, 14, 13, 17, 12.48)


M2_Boys <- c(28.3, 28.5, 33.8, 35.7, 32.5, 31.7, 32.6, 34.3, 32, 38.2, 35, 32.1, 35.5, 32.6, 32, 38, 35.8, 35.1, 38, 39.2, 37, 40.5, 38.4, 
          35.8, 39, 37.3, 37.5, 41.4, 39.3, 35.8, 34.2, 39.6, 33.6, 40.3, 36.8, 30.4, 40.1, 35.9, 35.2, 38.5, 42.4, 42.4, 36.9, 38.9, 43.2,
          39, 38.9, 38.1, 44.1, 44, 42.7, 47, 41.8, 40, 34.9, 39.1, 43.3, 42.4, 45.7, 40.5, 43.9, 51.4, 44.5, 48.2, 44.5, 43.7, 50.4, 43, 
          45.6, 44.1, 45.5, 46, 41.6, 44.1, 53, 43.5, 46.4, 46, 46.9, 46.9, 51.6, 47.4, 45.7, 50.3, 49.4, 47, 51.6, 51.2, 51.6, 49.5, 47.1, 
          47.6, 50.1, 47.2, 48.7, 48.9, 41.6, 48, 46.9, 56.5, 54.8, 52.9, 49.8, 48, 52, 47.9, 49.5, 48.7, 50.7, 47.9, 52.4, 56.5, 51.4, 55.5, 
          48, 50.3, 51.3, 54.2, 49, 53, 58.3, 54.7, 49.6, 52.3, 52.1, 50.6, 52, 56.5, 64.5, 56.3, 48.3, 53.6, 59.3, 46.9, 60.5, 53.1, 51.2, 
          58.6, 63.5, 56.7, 60.2, 57.8, 54.8, 52.2, 54.4, 57.5, 61, 57.7, 62.7, 63.6, 57.9, 55.9, 60, 67.1, 55.7, 60.3, 52.6, 54.6, 55.1, 
          54.7, 54.2, 64, 55.6, 56.9, 59.8, 61.8, 75.1, 63.3, 64, 57.5, 55.4, 56.2, 57.1, 67.7, 61.1, 61.8, 59.7, 48.9, 64.4, 59.8, 61.8, 
          58.6, 62.4, 64.6, 60.6, 68.8, 68.1, 67.7, 86.8, 69.9, 64.7, 71.9, 59.5, 71, 63.8, 70.6, 63.4, 72.2, 61.5, 60, 65.8, 65.7, 60.3, 
          69.4, 72.2, 75, 64.5, 67.1, 63.9, 72.3, 63.6, 61.1, 68.6, 61.4, 65, 66.3, 61, 66.1, 55.9)


df_B <- data.frame(M2_Boys, 
                   Estimated_Bone_Age_Boys, 
                   Chronological_Age_Boys)

BoysF <- function(x)
{
  y <- numeric(length=(x))
  
  for(i in 1:length(x)){
    if(x[i]>=0 & x[i]<3){
      y[i] <- 0.95
    } else if(x[i]>=3 & x[i]<4){
      y[i] <- 0.86
    } else if(x[i]>=4 & x[i]<5){
      y[i] <- 1.19
    } else if(x[i]>=5 & x[i]<6){
      y[i] <- 1.35
    } else if(x[i]>=6 & x[i]<7){
      y[i] <- 0.98
    } else if(x[i]>=7 & x[i]<8){
      y[i] <- 0.84
    } else if(x[i]>=8 & x[i]<9){
      y[i] <- 1.10
    } else if(x[i]>=9 & x[i]<10){
      y[i] <- 1.02
    } else if(x[i]>=10 & x[i]<11){
      y[i] <- 1.69
    } else if(x[i]>=11 & x[i]<12){
      y[i] <- 1.34
    } else if(x[i]>=12 & x[i]<13){
      y[i] <- 1.93
    } else if(x[i]>=13 & x[i]<14){
      y[i] <- 1.53
    } else if(x[i]>=14 & x[i]<15){
      y[i] <- 2.22
    } else if(x[i]>= 15){
      y[i] <- 1.63
    }
  }
  return(y)
}

Boys <- BoysF


# girls

Chronological_Age_Girls <- c(2.11, 2.14, 2.19, 2.23, 2.23, 2.25, 2.36, 2.5, 2.5, 2.5, 2.72, 
                       2.73, 2.84, 2.85, 3.07, 3.08, 3.08, 3.12, 3.15, 3.2, 3.2, 3.27, 
                       3.3, 3.35, 3.4, 3.42, 3.47, 3.56, 3.63, 3.68, 3.7, 3.76, 3.94, 
                       3.99, 4.02, 4.26, 4.32, 4.39, 4.41, 4.5, 4.5, 4.53, 4.54, 4.78, 
                       4.93, 5.06, 5.1, 5.1, 5.24, 5.25, 5.34, 5.34, 5.37, 5.4, 5.62, 5.77, 
                       5.8, 5.83, 5.84, 5.89, 5.9, 5.92, 5.94, 6.01, 6.06, 6.07, 6.17, 6.55,
                       6.56, 6.66, 6.77, 6.84, 6.86, 6.91, 6.91, 7.05, 7.2, 7.33, 7.35, 7.39, 
                       7.4, 7.44, 7.48, 7.54, 7.57, 7.63, 7.69, 7.73, 7.8, 7.81, 7.81, 7.85, 7.85, 
                       7.89, 7.91, 8.04, 8.08, 8.11, 8.17, 8.28, 8.29, 8.55, 8.61, 8.68, 8.68, 8.69, 
                       8.69, 8.84, 8.86, 8.86, 8.93, 8.94, 9.09, 9.11, 9.16, 9.2, 9.21, 9.23, 9.24, 9.25, 
                       9.26, 9.3, 9.6, 9.63, 9.63, 9.7, 9.85, 9.85, 9.92, 9.94, 9.99, 10.05, 10.1, 10.1, 10.15, 
                       10.17, 10.23, 10.33, 10.35, 10.4, 10.41, 10.41, 10.43, 10.54, 10.56, 10.78, 10.82, 
                       10.86, 10.89, 10.95, 11.02, 11.05, 11.06, 11.29, 11.3, 11.38, 11.47, 11.48, 11.49, 
                       11.63, 11.64, 11.66, 11.84, 11.88, 11.96, 12.08, 12.1, 12.19, 12.28, 12.32, 12.35, 
                       12.47, 12.6, 12.67, 12.69, 12.85, 12.85, 12.86, 12.93, 13.04, 13.04, 13.26, 13.3, 
                       13.4, 13.51, 13.54, 13.61, 13.63, 13.71, 13.72, 13.79, 13.84, 13.85, 13.98, 14.13, 
                       14.13, 14.19, 14.26, 14.41, 14.41, 14.43, 14.52, 14.64, 14.85, 14.88, 14.98, 15.12, 
                       15.17, 15.22, 15.28, 15.33, 15.37, 15.47, 15.64, 15.88)

Estimated_Bone_Age_Girls <- c(2, 2, 2.24, 2.64, 2.5, 2.48, 2.48, 2.48, 2.48, 2.48, 2.72, 3, 2.5, 2.48, 4.16, 4.16, 
                 2.5, 2.72, 3.8, 3, 3.24, 3, 2.5, 3, 2.72, 3, 4.16, 2.48, 4, 3, 3, 4.16, 4.4, 2.5, 3.5, 
                 5, 4, 3.72, 3.72, 5, 4.16, 4, 4.16, 5.48, 3.48, 5.4, 5.72, 4.16, 3.72, 4.16, 5, 5.72, 5, 
                 4.16, 6.4, 6.5, 6.8, 5, 5.72, 4.48, 6.8, 5, 5, 8.8, 6.5, 6.8, 7.72, 6.8, 8.8, 6.8, 6.32, 
                 5, 6.8, 7.8, 7.32, 7.4, 5.72, 7.32, 7.72, 10, 6.64, 9, 6.8, 6.8, 7.32, 7.4, 8.8, 8.8, 7.8, 
                 8.8, 7.32, 5.72, 10, 8.8, 7.5, 7.8, 9.32, 10, 10, 7.8, 9.5, 7.8, 8.8, 7.8, 8.8, 7.8, 10, 8.4,
                 8.4, 8, 9.32, 10, 11, 7.8, 10, 8.72, 8.8, 10, 8.8, 10, 10, 8.48, 8.24, 8.5, 11, 11, 8.8, 10, 
                 10, 8.8, 11, 10.5, 10, 8.32, 11, 10, 11, 11, 11, 8.8, 11, 11, 11, 11.4, 11, 10, 10, 11, 11.5,
                 11, 11, 10, 9.32, 11, 11, 13, 12, 11, 11, 11.48, 12, 13, 11.5, 11, 12, 12.5, 13, 12, 13, 12, 
                 13.73, 12, 11.48, 11, 12, 13.5, 15, 11, 14, 13.48, 14.5, 13.48, 15, 14, 14, 12, 13.24, 13.72, 
                 15, 13.5, 14.48, 15.5, 13, 13, 14, 16, 12, 15, 14.5, 14.5, 15, 15, 13, 16.5, 15, 17, 17, 16.48, 
                 14.5, 16, 15, 16.48, 13.24, 16.48, 16)


M2_Girls <- c(32.8, 34.6, 31.2, 32.6, 35.4, 33.3, 34.8, 34.3, 37, 32.2, 34.2, 35.9, 37, 37.2, 34.1, 36.6, 36.8, 33.6, 
        34.8, 35.2, 39.1, 34.5, 36, 38.5, 38.2, 39.9, 39.5, 37.5, 35.8, 37, 38.2, 39.9, 35.9, 34.8, 36.6, 40.5, 
        38.9, 40.9, 39.3, 38.7, 42.8, 33.2, 32.3, 41.4, 37.6, 38.5, 40.1, 40, 44.3, 36.7, 42.9, 43.8, 43.4, 41.4, 
        48, 40.1, 42, 43.6, 46.1, 44.9, 40.9, 39.7, 40.1, 46.3, 45.1, 48.2, 45.1, 44.9, 53.1, 46.4, 46.8, 43.9, 
        45.3, 55.7, 50.3, 50.5, 46.2, 47.3, 49.2, 50.5, 47.6, 47.4, 43.9, 44.4, 43.3, 52.1, 46.8, 52.6, 47.4, 48.8, 
        45.7, 46.3, 42.5, 50.7, 47.9, 52.4, 50, 54.3, 50, 46.6, 55.4, 50.5, 52.5, 52.2, 48.8, 44.5, 59.8, 48.9, 49.9, 
        49.2, 49.2, 55, 52.5, 47.5, 51.5, 54.4, 45, 49.5, 51.8, 56.1, 53.7, 52.3, 49.2, 49.2, 53.9, 55.7, 49.6, 58.4, 58.8, 
        51.9, 54.4, 57, 57.1, 50.6, 62.9, 61, 54.5, 55.6, 53.4, 52.7, 56.4, 52, 65, 56, 55.6, 55.3, 53.3, 52.5, 62, 62.2, 
        62.9, 54.7, 46.6, 56.8, 53.4, 57, 55.7, 61.1, 61.8, 53.3, 61, 63, 56.7, 60.2, 63.2, 62.3, 58.5, 62.7, 61.4, 57, 
        58.3, 61.9, 61.3, 64.3, 61.9, 63.4, 65, 65.6, 61.5, 64.1, 60.1, 63.6, 64, 60.7, 63.3, 55.5, 62.3, 60.2, 61.6, 
        61.3, 66.7, 68.7, 61.9, 62.6, 63.1, 69.2, 62.7, 58.5, 58.8, 64, 71.4, 61.8, 57.8, 64.3, 62.3, 62.7, 65, 64.3, 
        64.4, 65.3, 62.3, 55.9, 61.6, 61.1, 59.8)

df_G <- data.frame(M2_Girls, 
                   Estimated_Bone_Age_Girls, 
                   Chronological_Age_Girls)


GirlsF <- function(x)
{
  y <- numeric(length=(x))
  
  for(i in 1:length(x)){
    if(x[i]>=0 & x[i]<3){
      y[i] <- 0.68
    } else if(x[i]>=3 & x[i]<4){
      y[i] <- 0.72
    } else if(x[i]>=4 & x[i]<5){
      y[i] <- 1.18
    } else if(x[i]>=5 & x[i]<6){
      y[i] <- 1.02
    } else if(x[i]>=6 & x[i]<7){
      y[i] <- 1.31
    } else if(x[i]>=7 & x[i]<8){
      y[i] <- 1.02
    } else if(x[i]>=8 & x[i]<9){
      y[i] <- 1.30
    } else if(x[i]>=9 & x[i]<10){
      y[i] <- 1.29
    } else if(x[i]>=10 & x[i]<11){
      y[i] <- 1.49
    } else if(x[i]>=11 & x[i]<12){
      y[i] <- 1.69
    } else if(x[i]>=12 & x[i]<13){
      y[i] <- 0.90
    } else if(x[i]>=13 & x[i]<14){
      y[i] <- 1.09
    } else if(x[i]>=14 & x[i]<15){
      y[i] <- 1.45
    } else if(x[i]>= 15){
      y[i] <- 1.09
    }
  }
  return(y)
}

Girls <- GirlsF

fun_choices <- c("Boys", "Girls")
#fun_args_list <- list(Girls= list(x=x), Boys=list(x=x))

df <- merge(data.frame(df_B, row.names=NULL), 
            data.frame(df_G, row.names=NULL), 
            by = 0, all = TRUE)[-1]

ui          <- fluidPage(
    titlePanel(div(column(width = 6, 
                          h1("Boneureka"),
                          h2("Estimated Bone Age based on M2 Length"), 
                          h3("Matina Boitsios, Paolo Simoni, Giovanni Briganti")), 
                    column(width = 6, tags$img(src = "Logo.png", 
                                               width="50%"))),
                ),
    sidebarPanel(
        p("Choose Estimated Bone age in either girls or boys"),
        selectInput(inputId = "ExpVar", 
                    label = "Estimated Bone Age", 
                    choices = colnames(select(df, -c(M2_Boys, 
                                                     M2_Girls,
                                                     Chronological_Age_Boys, 
                                                     Chronological_Age_Girls)))),
        p("Choose M2 length in either girls or boys"),
        selectInput(inputId = "PreVar", 
                    label = "M2 length (mm)", 
                    choices = colnames(select(df, -c(Estimated_Bone_Age_Boys, 
                                            Estimated_Bone_Age_Girls, 
                                            Chronological_Age_Boys, 
                                            Chronological_Age_Girls)))),
        p("Choose Boys or Girls function for SDS"), 
        selectInput(inputId="Func",
                    label="Sex", 
                    choices=fun_choices),
        p("Choose Date of Birth"),
        dateInput("Age", 
                  "Date.Birth", 
                  format="yyyy-mm-dd"),
        p("Choose Date of Exam"),
        dateInput("Exam", 
                  "Date.Exam", 
                  format="yyyy-mm-dd"),
        numericInput(inputId = "Pred", 
                     label = "Select the measured M2 length in mm", 
                     value = 10),
        h3("Estimated Bone Age (in years) - SDS - Chronological Age (in years)"),
        textOutput("prediction")))

server      <- function(input, output){
    
    modpred <- reactive({
        Pre     <- input$Pred
        Pname   <- input$PreVar
        Func    <- get(input$Func)
        Age1    <- as.Date(input$Age)
        Exam1   <- as.Date(input$Exam)
        Age2    <- as.numeric(difftime(Exam1,
                                       Age1, 
                                       unit="weeks"))/52.25
        Func1   <- Func(Age2)[1]
        mod     <- lm(reformulate(input$PreVar, input$ExpVar), data=df)
        new_df  <- data.frame(Pre)
        names(new_df) <- Pname
        pred1 <- predict(mod, newdata = new_df)
        SDS1 <- (pred1-Age2)/Func1
        combo <- c(pred1, SDS1, Age2)
        combo
    })
    
    output$prediction <- renderText({
        modpred()
        })
    
}

shinyApp(ui, server)
